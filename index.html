<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Penguin's Bday</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ff7aa8;
      --bg2:#ffc2d6;
      --bg3:#bda7ff;

      --primary:#ff3d7f;
      --primary2:#ff66a6;

      --glass: rgba(255,255,255,0.22);
      --glass2: rgba(255,255,255,0.14);
      --border: rgba(255,255,255,0.35);

      --text: rgba(255,255,255,0.96);

      --shadow: 0 18px 60px rgba(0,0,0,0.18);
      --shadow2: 0 10px 28px rgba(0,0,0,0.16);

      --radius: 26px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      overflow-x:hidden;
      font-family:'Outfit', sans-serif;
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding: 26px 0 46px;
      position:relative;

      background: radial-gradient(1200px 700px at 20% 15%, rgba(255,255,255,0.35), transparent 55%),
                  radial-gradient(900px 600px at 85% 25%, rgba(255,255,255,0.22), transparent 60%),
                  linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
      background-size: 100% 100%, 100% 100%, 300% 300%;
      animation: gradientBG 14s ease infinite;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background:
        radial-gradient(2px 2px at 15% 20%, rgba(255,255,255,.9), transparent 60%),
        radial-gradient(2px 2px at 35% 75%, rgba(255,255,255,.7), transparent 60%),
        radial-gradient(2px 2px at 70% 30%, rgba(255,255,255,.8), transparent 60%),
        radial-gradient(1.5px 1.5px at 85% 70%, rgba(255,255,255,.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 55% 45%, rgba(255,255,255,.65), transparent 60%);
      opacity:.55;
      filter: blur(.2px);
    }

    @keyframes gradientBG{
      0%{ background-position: 0 0, 0 0, 0% 50%; }
      50%{ background-position: 0 0, 0 0, 100% 50%; }
      100%{ background-position: 0 0, 0 0, 0% 50%; }
    }

    h1{
      font-family:'Playfair Display', serif;
      font-size: clamp(1.8rem, 3.8vw, 2.35rem);
      margin: 10px 0 18px;
      letter-spacing: 0.2px;
      text-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }

    .glass-panel{
      width: 88%;
      max-width: 420px;
      margin-bottom: 18px;
      padding: 18px 16px;
      border-radius: var(--radius);

      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);

      position:relative;
      overflow:hidden;
      text-align:center;
    }

    .glass-panel::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(135deg, rgba(255,255,255,0.28), transparent 40%);
      opacity:.9;
    }

    .polaroid{
      padding: 12px;
      border-radius: 22px;
      background: rgba(255,255,255,0.82);
      box-shadow: var(--shadow2);
      position:relative;
    }

    .polaroid::after{
      content:"";
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: 10px;
      height: 18px;
      border-radius: 10px;
      background: rgba(255,255,255,0.75);
      filter: blur(0.2px);
      opacity: 0.65;
    }

    .polaroid img{
      width:100%;
      height: 320px;
      object-fit:cover;
      border-radius: 16px;
      display:block;
      background: rgba(0,0,0,0.06);
    }

    #error-debug{
      color:#fff;
      background: rgba(255, 45, 114, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.35);
      padding: 10px 12px;
      font-size: 0.78rem;
      margin-top: 10px;
      display:none;
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      position: relative;
      z-index: 5;
      text-align:left;
    }

    .scratch-box{
      position: relative;
      width: 100%;
      height: 160px;
      overflow: hidden;
      border-radius: 18px;
      margin-top: 14px;
      background: rgba(255,255,255,0.16);
      border: 1px solid rgba(255,255,255,0.28);
      box-shadow: 0 12px 28px rgba(0,0,0,0.10);
    }

    .hidden-text{
      position: absolute;
      inset: 0;
      display: block;
      padding: 16px 16px;
      font-style: italic;
      font-size: 1.02rem;
      line-height: 1.5;
      color: rgba(255,255,255,0.96);
      text-shadow: 0 8px 24px rgba(0,0,0,0.18);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      z-index: 1;
    }

    .hidden-text::-webkit-scrollbar{ width: 8px; }
    .hidden-text::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.35);
      border-radius: 99px;
    }
    .hidden-text::-webkit-scrollbar-track{
      background: rgba(255,255,255,0.10);
      border-radius: 99px;
    }

    canvas{
      position:absolute;
      top:0; left:0;
      z-index:2;
      touch-action:none;
      border-radius: 18px;
    }

    canvas.disabled{
      pointer-events:none;
    }

    .hug-btn{
      margin-top: 14px;
      border: none;
      padding: 13px 28px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.2px;
      cursor:pointer;

      color: white;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 14px 30px rgba(255, 61, 127, 0.28);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
      position: relative;
      z-index: 5;
    }

    .hug-btn:hover{
      transform: translateY(-2px);
      filter: brightness(1.02);
      box-shadow: 0 18px 40px rgba(255, 61, 127, 0.34);
    }
    .hug-btn:active{
      transform: translateY(0px) scale(0.99);
    }

    .calendar-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 9px;
      margin-top: 12px;
      padding: 2px;
      position: relative;
      z-index: 5;
    }

    .day-bubble{
      aspect-ratio:1;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 0.8rem;
      font-weight: 700;
      cursor:pointer;
      user-select:none;

      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      color: rgba(255,255,255,0.88);

      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, opacity .18s ease;
    }

    .day-bubble.unlocked{
      background: rgba(255,255,255,0.86);
      color: rgba(255, 30, 90, 0.92);
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }
    .day-bubble.unlocked:hover{
      transform: translateY(-2px);
    }

    .day-bubble.active{
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:white;
      border:none;
      box-shadow: 0 0 0 5px rgba(255,255,255,0.22), 0 18px 40px rgba(255, 61, 127, 0.35);
      transform: scale(1.08);
      z-index: 6;
    }

    .day-bubble.locked{
      opacity: 0.32;
      cursor:not-allowed;
      background: rgba(255,255,255,0.10);
      border: 1px dashed rgba(255,255,255,0.22);
    }

    #game-screen{
      position:fixed;
      inset:0;
      z-index:1000;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;

      background: rgba(255, 175, 206, 0.16);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      transition: 0.5s;
      text-align: center;
      padding: 0 20px;
    }

    #game-screen h2{
      margin:0 0 14px;
      font-family:'Playfair Display';
      font-weight: 600;
      color: rgba(255,255,255,0.96);
      text-shadow: 0 14px 38px rgba(0,0,0,0.18);
    }

    #heart-mover{
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      will-change: transform;
      display: inline-block;
    }

    .heart-floater{
      font-size: 92px;
      cursor:pointer;
      animation: pulse 0.95s infinite alternate;
      filter: drop-shadow(0 0 22px rgba(255, 61, 127, 0.55));
      user-select: none;
      opacity: 0.55;            /* will be set to 1 when data is ready */
      pointer-events: none;     /* will be enabled when data is ready */
    }

    @keyframes pulse{
      from{ transform: scale(1); }
      to{ transform: scale(1.08); }
    }

    .hidden{ display:none; }

    h3{
      margin: 0 0 14px 0;
      font-size: 0.92rem;
      letter-spacing: 2px;
      font-weight: 500;
      color: rgba(255,255,255,0.82);
      position: relative;
      z-index: 5;
    }

    #days-left{
      margin-top: 18px;
      font-size: 0.82rem;
      opacity: 0.78;
      font-weight: 400;
      position: relative;
      z-index: 5;
    }

    #distance-tag{
      font-size: 0.78rem;
      opacity: 0.78;
      margin-top: 10px;
      font-weight: 400;
      text-shadow: 0 10px 24px rgba(0,0,0,0.14);
    }
  </style>
</head>

<body>
  <div id="game-screen">
    <h2>Every day is a gift...</h2>

    <div id="heart-mover">
      <div id="target-heart" class="heart-floater">üíù</div>
    </div>

    <p style="color: rgba(255,255,255,0.75); margin-top:30px; letter-spacing: 1px; font-size: 0.8rem;">
      CATCH THE HEART TO UNLOCK TODAY
    </p>
    <p id="loading-note" style="color: rgba(255,255,255,0.75); margin-top:8px; letter-spacing: 0.5px; font-size: 0.78rem;">
      Loading surprises...
    </p>
  </div>

  <div id="main-app" class="hidden">
    <h1 id="date-title"></h1>

    <div class="glass-panel">
      <div class="polaroid">
        <img id="display-img" src="" alt="Loading..." onerror="imageFailed(this)">
      </div>
      <div id="error-debug"></div>

      <div class="scratch-box">
        <div class="hidden-text" id="display-msg"></div>
        <canvas id="scratch-canvas"></canvas>
      </div>

      <button class="hug-btn" onclick="sendHug()">Send Hug ü§ó</button>
    </div>

    <div class="glass-panel" style="width: 92%; max-width: 420px;">
      <h3 style="margin: 0 0 15px 0; font-size: 0.9rem; opacity: 0.85; letter-spacing: 2px; font-weight: 500;">
        My Baby's Month
      </h3>
      <div class="calendar-grid" id="calendar-wrapper"></div>
      <div id="days-left" style="margin-top: 20px; font-size: 0.8rem; opacity: 0.75; font-weight: 400;"></div>
    </div>

    <div style="font-size: 0.75rem; opacity: 0.78; margin-top: 10px; font-weight: 400;" id="distance-tag"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script>
    // --- MANDATORY SETUP ---
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSKqWbkDWDomm_5dSZhriAHQAx3EG_jPrulurvlmkdlUl7XoF4pkz5KT-5JMHyauG_JbzQBDAYsdbuS/pub?gid=0&single=true&output=csv';
    // ------------------------

    let allData = [];
    let actualDayNum = 1;

    // Data gating (FIX #1)
    let dataReady = false;

    function imageFailed(img) {
      const errBox = document.getElementById('error-debug');
      errBox.style.display = 'block';
      errBox.innerHTML = `‚ö†Ô∏è <b>File Error</b><br>Code tried to load: <i>"${img.src.split('/').pop()}"</i><br>Does this match your GitHub filename exactly?`;
    }

    // FIX #2: robust date normalization to YYYY-MM-DD
    // IMPORTANT: For ambiguous 2/2/2026 dates, this assumes MM/DD/YYYY.
    // If your sheet is DD/MM/YYYY, swap m and d in the slashed-date block.
    function normalizeToISODate(raw) {
      if (raw == null) return null;
      const s = String(raw).trim();
      if (!s) return null;

      // ISO-ish: 2026-02-02 or 2026/02/02
      const iso = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
      if (iso) {
        const y = iso[1];
        const m = String(iso[2]).padStart(2, '0');
        const d = String(iso[3]).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      // Slashed: 2/2/2026
      const sl = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (sl) {
        const a = parseInt(sl[1], 10);
        const b = parseInt(sl[2], 10);
        const y = sl[3];

        // ASSUME MM/DD/YYYY (US). If your sheet is DD/MM/YYYY, swap these:
        const m = String(a).padStart(2, '0');
        const d = String(b).padStart(2, '0');

        return `${y}-${m}-${d}`;
      }

      // Fallback parse: "Feb 2, 2026"
      const dt = new Date(s);
      if (!isNaN(dt.getTime())) {
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const d = String(dt.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }

      return null;
    }

    // FIX #1 + #3: load as Promise + cache-buster
    function loadData() {
      const url = `${SHEET_URL}&cache=${Date.now()}`;
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          complete: function (results) {
            allData = (results.data || []).filter(r => (r.Date || r.date || r.ImageName || r.Message));
            dataReady = true;

            // Enable heart clicking only after data is ready
            const heart = document.getElementById('target-heart');
            heart.style.opacity = '1';
            heart.style.pointerEvents = 'auto';

            const note = document.getElementById('loading-note');
            if (note) note.innerText = 'Ready! Catch the heart.';

            resolve();
          },
          error: function (err) {
            reject(err);
          }
        });
      });
    }

    async function init() {
      // Use SG date as you intended
      const options = { timeZone: 'Asia/Singapore', year: 'numeric', month: '2-digit', day: '2-digit' };
      const formatter = new Intl.DateTimeFormat('en-CA', options);
      const sgDate = formatter.format(new Date()); // "YYYY-MM-DD"
      actualDayNum = parseInt(sgDate.split('-')[2], 10);

      // Disable heart until data loads
      const heart = document.getElementById('target-heart');
      heart.style.opacity = '0.55';
      heart.style.pointerEvents = 'none';

      try {
        await loadData();
      } catch (e) {
        const note = document.getElementById('loading-note');
        if (note) note.innerText = 'Failed to load surprises.';
        const errBox = document.getElementById('error-debug');
        errBox.style.display = 'block';
        errBox.innerHTML = `‚ö†Ô∏è <b>Data Load Failed</b><br>${String(e)}<br><br>
          Check if your Google Sheet is <b>published</b> and the link is correct.`;
      }
    }

    // Heart move logic
    const heartMover = document.getElementById('heart-mover');
    let clicks = 0;

    function moveHeart() {
      // FIX #1: hard gate
      if (!dataReady) return;

      if (clicks < 2) {
        heartMover.style.transform = `translate(${Math.random() * 160 - 80}px, ${Math.random() * 160 - 80}px)`;
        clicks++;
      } else {
        document.getElementById('game-screen').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('game-screen').style.display = 'none';
          document.getElementById('main-app').classList.remove('hidden');

          // Now elements have sizes => scratch works
          renderContent(actualDayNum);
          renderCalendar(actualDayNum);
        }, 500);
      }
    }

    document.getElementById('target-heart').addEventListener('click', moveHeart);

    function renderContent(day) {
      const dayStr = String(day).padStart(2, '0');
      const searchDate = `2026-02-${dayStr}`;

      // FIX #2: exact match after normalization
      const row = allData.find(r => {
        const raw = (r.Date || r.date || "").toString();
        const iso = normalizeToISODate(raw);
        return iso === searchDate;
      });

      document.getElementById('date-title').innerText = `February ${day}`;

      const imgElement = document.getElementById('display-img');
      const msgElement = document.getElementById('display-msg');
      const errBox = document.getElementById('error-debug');

      if (row) {
        errBox.style.display = 'none';

        const rawName = (row.ImageName || row.imagename || row.IMAGE || "").toString().trim();
        imgElement.src = rawName ? rawName : `${searchDate}.jpg.jpg`;

        msgElement.innerText = (row.Message || row.message || row.MESSAGE || "Message column not found in sheet!").toString();
      } else {
        errBox.style.display = 'block';
        // Extra debug info to help you instantly see what dates are coming in
        const sampleDates = allData.slice(0, 8).map(r => (r.Date || r.date || '')).join(' | ');
        errBox.innerHTML = `‚ö†Ô∏è <b>Data Sync Error</b><br>
          Could not find a row for <b>${searchDate}</b> in your Sheet.<br><br>
          <b>Quick debug:</b><br>
          - actualDayNum = ${actualDayNum}<br>
          - rows loaded = ${allData.length}<br>
          - sample raw dates = ${sampleDates}`;

        imgElement.src = `${searchDate}.jpg.jpg`;
        msgElement.innerText = "Check your Google Sheet date format (or DD/MM vs MM/DD).";
      }

      initScratch();
    }

    function renderCalendar(currentView) {
      const grid = document.getElementById('calendar-wrapper');
      grid.innerHTML = '';

      for (let i = 1; i <= 28; i++) {
        const bubble = document.createElement('div');
        bubble.innerText = i;
        bubble.className = 'day-bubble';

        if (i === currentView) {
          bubble.classList.add('active');
        } else if (i <= actualDayNum) {
          bubble.classList.add('unlocked');
          bubble.onclick = () => { renderContent(i); renderCalendar(i); };
        } else {
          bubble.classList.add('locked');
          bubble.innerHTML = 'üîí';
        }
        grid.appendChild(bubble);
      }

      const left = 28 - actualDayNum;
      document.getElementById('days-left').innerText = `${left} SURPRISES REMAINING...`;
      setDistanceTag();
    }

    // Scratch: works + disables canvas after enough scratch so message can scroll
    function initScratch() {
      const canvas = document.getElementById('scratch-canvas');
      const ctx = canvas.getContext('2d');
      const parent = canvas.parentElement;

      canvas.width = parent.offsetWidth;
      canvas.height = parent.offsetHeight;

      canvas.classList.remove("disabled");

      ctx.globalCompositeOperation = 'source-over';

      const grd = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
      grd.addColorStop(0, '#ffd1e3');
      grd.addColorStop(1, '#ff5fa2');
      ctx.fillStyle = grd;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "white";
      ctx.font = "bold 14px Outfit";
      ctx.textAlign = "center";
      ctx.fillText("SCRATCH TO READ", canvas.width / 2, canvas.height / 2 + 5);

      ctx.globalCompositeOperation = 'destination-out';

      let isDown = false;

      function getXY(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = (e.touches && e.touches[0]) ? e.touches[0].clientX : e.clientX;
        const clientY = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      function scratchAt(e) {
        const { x, y } = getXY(e);
        ctx.beginPath();
        ctx.arc(x, y, 26, 0, Math.PI * 2);
        ctx.fill();
      }

      function maybeDisableCanvas() {
        const img = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        let transparent = 0;
        for (let i = 3; i < img.length; i += 4) {
          if (img[i] === 0) transparent++;
        }
        const ratio = transparent / (img.length / 4);

        if (ratio > 0.45) {
          canvas.classList.add("disabled");
        }
      }

      // Mouse
      canvas.onmousedown = (e) => { isDown = true; scratchAt(e); };
      canvas.onmousemove = (e) => { if (!isDown) return; e.preventDefault(); scratchAt(e); };
      window.onmouseup = () => { if (isDown) { isDown = false; maybeDisableCanvas(); } };

      // Touch
      canvas.ontouchstart = (e) => { isDown = true; e.preventDefault(); scratchAt(e); };
      canvas.ontouchmove = (e) => { if (!isDown) return; e.preventDefault(); scratchAt(e); };
      canvas.ontouchend = () => { if (isDown) { isDown = false; maybeDisableCanvas(); } };
    }

    function sendHug() {
      for (let i = 0; i < 15; i++) {
        const h = document.createElement('div');
        h.innerText = '‚ù§Ô∏è';
        h.style.position = 'fixed';
        h.style.left = '50%';
        h.style.top = '50%';
        h.style.transition = '2s';
        h.style.pointerEvents = 'none';
        h.style.zIndex = '3000';
        document.body.appendChild(h);

        setTimeout(() => {
          h.style.transform = `translate(${(Math.random() - 0.5) * 400}px, ${(Math.random() - 0.5) * 600}px) scale(3) rotate(${Math.random() * 360}deg)`;
          h.style.opacity = '0';
        }, 10);

        setTimeout(() => h.remove(), 2000);
      }
    }

    // Hardcoded distance exactly as you asked
    function setDistanceTag() {
      document.getElementById('distance-tag').innerText = `üìç 3997 KM APART, BUT TOGETHER FOREVER`;
    }

    init();
  </script>
</body>
</html>
